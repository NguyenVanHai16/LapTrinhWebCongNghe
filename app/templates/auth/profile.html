{% extends "layout.html" %}

{% block styles %}
{{ super() }}
<link rel="stylesheet" href="/static/css/profile.css">
{% endblock %}

{% block content %}
<div class="container profile-container">
    <h1 class="profile-title">Thông tin tài khoản</h1>

    <div class="account-info">
        <div class="card">
            <div class="card-header">
                <h2>Thông tin cá nhân</h2>
                <button class="btn btn-outline edit-btn" data-toggle="personal-info">Chỉnh sửa</button>
            </div>

            <div class="card-body">
                <div class="info-row">
                    <div class="info-group">
                        <label class="form-label">Tên đăng nhập</label>
                        <div class="info-value">{{ current_user.username }}</div>
                    </div>
                    <div class="info-group">
                        <label class="form-label">Email</label>
                        <div class="info-value" data-field="email">{{ current_user.email }}</div>
                    </div>
                </div>

                <div class="info-row">
                    <div class="info-group">
                        <label class="form-label">Họ và tên</label>
                        <div class="info-value {% if not (current_user.last_name or current_user.first_name) %}empty-value{% endif %}" data-field="full_name">
                            {% if current_user.last_name or current_user.first_name %}
                                {{ current_user.last_name }} {{ current_user.first_name }}
                            {% else %}
                                Chưa cập nhật
                            {% endif %}
                        </div>
                    </div>
                    <div class="info-group">
                        <label class="form-label">Ngày tham gia</label>
                        <div class="info-value">{{ current_user.created_at.strftime('%d/%m/%Y') }}</div>
                    </div>
                </div>

                <form class="edit-form d-none" id="personal-info-form" action="/update-profile" method="POST">
                    {{ form.csrf_token if form }}
                    <div class="form-message" id="personal-info-message"></div>
                    <div class="form-group">
                        <label class="form-label" for="email">Email</label>
                        <input type="email" class="form-control" id="email" name="email" value="{{ current_user.email }}" required>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label" for="last_name">Họ</label>
                            <input type="text" class="form-control" id="last_name" name="last_name" value="{{ current_user.last_name }}">
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="first_name">Tên</label>
                            <input type="text" class="form-control" id="first_name" name="first_name" value="{{ current_user.first_name }}">
                        </div>
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn btn-outline cancel-btn" data-toggle="personal-info">Hủy</button>
                        <button type="submit" class="btn btn-primary">Lưu thay đổi</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="activity-section">
        <div class="card">
            <div class="card-header">
                <h2>Địa chỉ giao hàng</h2>
            </div>

            <div class="card-body">
                {% if addresses %}
                    {% for address in addresses %}
                        <div class="address-item" data-address-id="{{ address.id }}">
                            <div class="address-info">
                                <div class="address-name">{{ address.recipient_name }}</div>
                                <div class="address-phone">{{ address.phone }}</div>
                                <div class="address-text">{{ address.address }}</div>
                                {% if address.is_default %}
                                    <span class="address-default badge">Mặc định</span>
                                {% endif %}
                            </div>
                            <div class="address-actions">
                                <button class="btn-icon edit-address-btn" data-toggle="edit-address" data-address-id="{{ address.id }}"><i class="fas fa-edit"></i></button>
                                <button class="btn-icon delete-address-btn" data-address-id="{{ address.id }}"><i class="fas fa-trash"></i></button>
                            </div>
                        </div>
                        <form class="address-form edit-address-form d-none" id="edit-address-form-{{ address.id }}" action="/update-address/{{ address.id }}" method="POST">
                            {{ form.csrf_token if form }}
                            <input type="hidden" name="address_id" value="{{ address.id }}">
                            <div class="form-group">
                                <label class="form-label" for="recipient_name_{{ address.id }}">Họ tên người nhận</label>
                                <input type="text" class="form-control" id="recipient_name_{{ address.id }}" name="recipient_name" value="{{ address.recipient_name }}" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="phone_{{ address.id }}">Số điện thoại</label>
                                <input type="text" class="form-control" id="phone_{{ address.id }}" name="phone" value="{{ address.phone }}" required pattern="^\d{10,11}$" title="Số điện thoại phải có 10 hoặc 11 chữ số">
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="address_{{ address.id }}">Địa chỉ chi tiết</label>
                                <input type="text" class="form-control" id="address_{{ address.id }}" name="address" value="{{ address.address }}" required>
                            </div>
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input" id="is_default_{{ address.id }}" name="is_default" {% if address.is_default %}checked{% endif %}>
                                <label class="form-check-label" for="is_default_{{ address.id }}">Đặt làm địa chỉ mặc định</label>
                            </div>
                            <div class="form-actions">
                                <button type="button" class="btn btn-outline cancel-btn" data-toggle="edit-address" data-address-id="{{ address.id }}">Hủy</button>
                                <button type="submit" class="btn btn-primary">Lưu địa chỉ</button>
                            </div>
                        </form>
                    {% endfor %}
                {% else %}
                    <div class="empty-state">
                        <p>Bạn chưa có địa chỉ giao hàng nào</p>
                    </div>
                {% endif %}

                <div class="add-new-address">
                    <button class="btn btn-outline add-address-btn" data-toggle="add-address">Thêm địa chỉ mới</button>
                </div>

                <form class="address-form add-address-form d-none" id="add-address-form" action="/add-address" method="POST">
                    {{ form.csrf_token if form }}
                    <div class="form-message" id="add-address-message"></div>
                    <div class="form-group">
                        <label class="form-label" for="recipient_name_add">Họ tên người nhận</label>
                        <input type="text" class="form-control" id="recipient_name_add" name="recipient_name" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="phone_add">Số điện thoại</label>
                        <input type="text" class="form-control" id="phone_add" name="phone" required pattern="^\d{10,11}$" title="Số điện thoại phải có 10 hoặc 11 chữ số">
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="address_add">Địa chỉ chi tiết</label>
                        <input type="text" class="form-control" id="address_add" name="address" required>
                    </div>
                    <div class="form-check">
                        <input type="checkbox" class="form-check-input" id="is_default_add" name="is_default">
                        <label class="form-check-label" for="is_default_add">Đặt làm địa chỉ mặc định</label>
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn btn-outline cancel-btn" data-toggle="add-address">Hủy</button>
                        <button type="submit" class="btn btn-primary">Lưu địa chỉ</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
document.addEventListener('DOMContentLoaded', () => {
    // Hàm ẩn tất cả form
    function hideAllAddressForms() {
        document.querySelectorAll('.address-form').forEach(form => {
            form.classList.add('d-none');
        });
        document.getElementById('add-address-message').textContent = '';
    }

    // Xử lý nút "Thêm địa chỉ mới"
    document.querySelector('.add-address-btn').addEventListener('click', () => {
        hideAllAddressForms();
        const addForm = document.getElementById('add-address-form');
        addForm.classList.remove('d-none');
        addForm.reset();
        addForm.scrollIntoView({ behavior: 'smooth' });
    });

    // Xử lý nút "Chỉnh sửa" cho từng địa chỉ
    document.querySelectorAll('.edit-address-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            hideAllAddressForms();
            const addressId = btn.dataset.addressId;
            const editForm = document.getElementById(`edit-address-form-${addressId}`);
            editForm.classList.remove('d-none');
            editForm.scrollIntoView({ behavior: 'smooth' });
        });
    });

    // Xử lý nút "Hủy" cho form địa chỉ
    document.querySelectorAll('.cancel-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            hideAllAddressForms();
        });
    });

    // Xử lý nút "Xóa địa chỉ"
    document.querySelectorAll('.delete-address-btn').forEach(btn => {
        btn.addEventListener('click', async () => {
            if (confirm('Bạn có chắc muốn xóa địa chỉ này?')) {
                const addressId = btn.dataset.addressId;
                try {
                    const response = await fetch(`/delete-address/${addressId}`, {
                        method: 'DELETE',
                        headers: {
                            'X-CSRF-Token': document.querySelector('input[name="csrf_token"]')?.value
                        }
                    });
                    if (response.ok) {
                        const addressItem = btn.closest('.address-item');
                        const editForm = document.getElementById(`edit-address-form-${addressId}`);
                        addressItem.remove();
                        if (editForm) editForm.remove();
                        if (!document.querySelectorAll('.address-item').length) {
                            const emptyState = document.querySelector('.empty-state') || document.createElement('div');
                            emptyState.className = 'empty-state';
                            emptyState.innerHTML = '<p>Bạn chưa có địa chỉ giao hàng nào</p>';
                            const cardBody = document.querySelector('.card-body');
                            cardBody.insertBefore(emptyState, document.querySelector('.add-new-address'));
                        }
                    } else {
                        alert('Xóa địa chỉ thất bại. Vui lòng thử lại.');
                    }
                } catch (error) {
                    console.error('Lỗi khi xóa địa chỉ:', error);
                    alert('Có lỗi xảy ra. Vui lòng thử lại.');
                }
            }
        });
    });

    // Xử lý nút "Chỉnh sửa" và "Hủy" cho form thông tin cá nhân
    document.querySelectorAll('[data-toggle="personal-info"]').forEach(btn => {
        btn.addEventListener('click', () => {
            const form = document.getElementById('personal-info-form');
            const infoRows = form.closest('.card-body').querySelectorAll('.info-row');
            form.classList.toggle('d-none');
            infoRows.forEach(row => row.classList.toggle('d-none'));
            document.getElementById('personal-info-message').textContent = '';
        });
    });

    // Xử lý gửi form thông tin cá nhân (AJAX)
    document.getElementById('personal-info-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const form = e.target;
        const messageDiv = document.getElementById('personal-info-message');
        const formData = new FormData(form);

        // Kiểm tra dữ liệu phía client
        const email = formData.get('email').trim();
        if (!email) {
            messageDiv.textContent = 'Vui lòng điền email.';
            messageDiv.className = 'form-message error';
            return;
        }

        try {
            const response = await fetch(form.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRF-Token': document.querySelector('input[name="csrf_token"]')?.value
                }
            });
            const result = await response.json();

            if (response.ok) {
                messageDiv.textContent = 'Cập nhật thông tin thành công!';
                messageDiv.className = 'form-message success';

                // Cập nhật giao diện
                const emailField = document.querySelector('.info-value[data-field="email"]');
                const fullNameField = document.querySelector('.info-value[data-field="full_name"]');
                const firstName = formData.get('first_name').trim();
                const lastName = formData.get('last_name').trim();

                emailField.textContent = email;
                if (firstName || lastName) {
                    fullNameField.textContent = `${lastName} ${firstName}`.trim();
                    fullNameField.classList.remove('empty-value');
                } else {
                    fullNameField.textContent = 'Chưa cập nhật';
                    fullNameField.classList.add('empty-value');
                }

                // Ẩn form và hiện thông tin
                form.classList.add('d-none');
                const infoRows = form.closest('.card-body').querySelectorAll('.info-row');
                infoRows.forEach(row => row.classList.remove('d-none'));
                setTimeout(() => messageDiv.textContent = '', 2000);
            } else {
                messageDiv.textContent = result.error || 'Cập nhật thông tin thất bại. Vui lòng thử lại.';
                messageDiv.className = 'form-message error';
            }
        } catch (error) {
            console.error('Lỗi khi cập nhật thông tin:', error);
            messageDiv.textContent = 'Có lỗi xảy ra. Vui lòng thử lại sau.';
            messageDiv.className = 'form-message error';
        }
    });

    // Xử lý gửi form thêm địa chỉ (AJAX)
    document.getElementById('add-address-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const form = e.target;
        const messageDiv = document.getElementById('add-address-message');
        const formData = new FormData(form);

        // Kiểm tra dữ liệu phía client
        const recipientName = formData.get('recipient_name').trim();
        const phone = formData.get('phone').trim();
        const address = formData.get('address').trim();

        if (!recipientName || !phone || !address) {
            messageDiv.textContent = 'Vui lòng điền đầy đủ các trường bắt buộc.';
            messageDiv.className = 'form-message error';
            return;
        }

        if (!/^\d{10,11}$/.test(phone)) {
            messageDiv.textContent = 'Số điện thoại phải có 10 hoặc 11 chữ số.';
            messageDiv.className = 'form-message error';
            return;
        }

        try {
            const response = await fetch(form.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRF-Token': document.querySelector('input[name="csrf_token"]')?.value
                }
            });
            const result = await response.json();

            if (response.ok) {
                messageDiv.textContent = 'Thêm địa chỉ thành công!';
                messageDiv.className = 'form-message success';

                // Thêm địa chỉ mới vào danh sách
                const addressList = document.querySelector('.card-body');
                const emptyState = document.querySelector('.empty-state');
                if (emptyState) emptyState.remove();

                const newAddressId = result.address_id || Date.now();
                const newAddressItem = document.createElement('div');
                newAddressItem.className = 'address-item';
                newAddressItem.dataset.addressId = newAddressId;
                newAddressItem.innerHTML = `
                    <div class="address-info">
                        <div class="address-name">${recipientName}</div>
                        <div class="address-phone">${phone}</div>
                        <div class="address-text">${address}</div>
                        ${formData.get('is_default') ? '<span class="address-default badge">Mặc định</span>' : ''}
                    </div>
                    <div class="address-actions">
                        <button class="btn-icon edit-address-btn" data-toggle="edit-address" data-address-id="${newAddressId}"><i class="fas fa-edit"></i></button>
                        <button class="btn-icon delete-address-btn" data-address-id="${newAddressId}"><i class="fas fa-trash"></i></button>
                    </div>
                `;

                // Thêm form chỉnh sửa cho địa chỉ mới
                const newEditForm = document.createElement('form');
                newEditForm.className = 'address-form edit-address-form d-none';
                newEditForm.id = `edit-address-form-${newAddressId}`;
                newEditForm.action = `/update-address/${newAddressId}`;
                newEditForm.method = 'POST';
                newEditForm.innerHTML = `
                    <input type="hidden" name="csrf_token" value="${document.querySelector('input[name="csrf_token"]')?.value}">
                    <input type="hidden" name="address_id" value="${newAddressId}">
                    <div class="form-group">
                        <label class="form-label" for="recipient_name_${newAddressId}">Họ tên người nhận</label>
                        <input type="text" class="form-control" id="recipient_name_${newAddressId}" name="recipient_name" value="${recipientName}" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="phone_${newAddressId}">Số điện thoại</label>
                        <input type="text" class="form-control" id="phone_${newAddressId}" name="phone" value="${phone}" required pattern="^\\d{10,11}$" title="Số điện thoại phải có 10 hoặc 11 chữ số">
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="address_${newAddressId}">Địa chỉ chi tiết</label>
                        <input type="text" class="form-control" id="address_${newAddressId}" name="address" value="${address}" required>
                    </div>
                    <div class="form-check">
                        <input type="checkbox" class="form-check-input" id="is_default_${newAddressId}" name="is_default" ${formData.get('is_default') ? 'checked' : ''}>
                        <label class="form-check-label" for="is_default_${newAddressId}">Đặt làm địa chỉ mặc định</label>
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn btn-outline cancel-btn" data-toggle="edit-address" data-address-id="${newAddressId}">Hủy</button>
                        <button type="submit" class="btn btn-primary">Lưu địa chỉ</button>
                    </div>
                `;

                // Chèn phần tử mới một cách an toàn
                const referenceNode = document.querySelector('.add-new-address');
                if (referenceNode && addressList.contains(referenceNode)) {
                    addressList.insertBefore(newAddressItem, referenceNode);
                    addressList.insertBefore(newEditForm, referenceNode);
                } else {
                    addressList.appendChild(newAddressItem);
                    addressList.appendChild(newEditForm);
                }

                // Đặt lại form và ẩn
                form.reset();
                setTimeout(() => hideAllAddressForms(), 2000);
            } else if (response.status === 404) {
                messageDiv.textContent = 'Không tìm thấy dịch vụ. Vui lòng kiểm tra cấu hình server.';
                messageDiv.className = 'form-message error';
            } else {
                messageDiv.textContent = result.error || 'Thêm địa chỉ thất bại. Vui lòng thử lại.';
                messageDiv.className = 'form-message error';
            }
        } catch (error) {
            console.error('Lỗi khi thêm địa chỉ:', error);
            messageDiv.textContent = 'Có lỗi xảy ra. Vui lòng thử lại sau.';
            messageDiv.className = 'form-message error';
        }
    });
});
</script>
{% endblock %}